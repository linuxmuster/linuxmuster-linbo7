#!/bin/sh
#
# linbo_warmstart <cachedevice>
# thomas@linuxmuster.net
# 20230212
#

if [ -n "$1" ]; then
  CACHE="$1"
else
  CACHE="$(grep -iw ^cache /start.conf | tail -1 | awk -F\= '{print $2}' | awk '{print $1}' | awk -F\# '{print $1}' | awk '{print $1}')"
fi

if [ ! -b "$CACHE" ]; then
  [ -z "$CACHE" ] && CACHE="<None>"
  echo "Cache $CACHE is not a blockdevice!"
  exit 1
fi

KEXEC="/sbin/kexec"
KERNEL="linbo64"
INITRD="linbofs64.lz"
APPEND="$(cat /proc/cmdline)"

# test for warmstart boot parameter
warmstart="yes"
for i in $APPEND; do case "$i" in warmstart=*) eval $i ;; esac; done

# warmstart or reboot in this cases
if [ "$warmstart" = "no" ]; then
  echo "Initiating linbo reboot ..."
  /sbin/reboot
  exit 0
else
  echo "Initiating linbo warmstart ..."
fi

cd /
linbo_cmd mountcache "$CACHE"

# load linbo kernel
if ! $KEXEC --type="bzImage64" --reuse-cmdline --initrd="/cache/$INITRD" --load "/cache/$KERNEL"; then
  echo "Failed to load kernel!"
  exit 1
fi
# execute linbo kernel
if ! $KEXEC -e; then
  echo "Failed to execute kernel!"
  exit 1
fi
